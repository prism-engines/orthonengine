<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√òrthon</title>
    <style>
        :root {
            --bg: #0d1117;
            --panel: #161b22;
            --input: #21262d;
            --border: #30363d;
            --text: #c9d1d9;
            --dim: #8b949e;
            --accent: #58a6ff;
            --green: #3fb950;
            --yellow: #d29922;
            --red: #f85149;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: ui-monospace, 'Cascadia Code', 'SF Mono', Consolas, monospace;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo { font-size: 1.3rem; font-weight: 600; }
        .logo span { color: var(--accent); }
        .tagline { color: var(--dim); font-size: 0.8rem; margin-left: auto; }

        main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: var(--border);
        }

        .panel {
            background: var(--panel);
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--dim);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        textarea {
            flex: 1;
            background: var(--input);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            font: inherit;
            font-size: 0.8rem;
            color: var(--text);
            resize: none;
            line-height: 1.5;
        }

        textarea:focus { outline: none; border-color: var(--accent); }

        .upload-zone {
            flex: 1;
            border: 2px dashed var(--border);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
            min-height: 150px;
        }

        .upload-zone:hover { border-color: var(--accent); background: rgba(88,166,255,0.05); }
        .upload-zone.has-file { border-color: var(--green); border-style: solid; }
        .upload-zone.dragover { border-color: var(--accent); background: rgba(88,166,255,0.1); }

        .upload-icon { font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5; }
        .upload-text { color: var(--dim); font-size: 0.8rem; text-align: center; }

        .file-info {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--input);
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .file-info .name { color: var(--green); }
        .file-info .size { color: var(--dim); float: right; }

        #cap-panel { grid-column: 1 / -1; max-height: 250px; overflow-y: auto; }

        .cap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.4rem;
        }

        .cap {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.6rem;
            background: var(--input);
            border-radius: 4px;
            font-size: 0.75rem;
            border-left: 3px solid var(--border);
        }

        .cap.ok { border-left-color: var(--green); }
        .cap.no { opacity: 0.4; }

        .cap-icon { width: 14px; text-align: center; }
        .cap-name { flex: 1; }

        .lvl {
            font-size: 0.6rem;
            padding: 0.1rem 0.3rem;
            border-radius: 2px;
            background: var(--bg);
        }

        .lvl-0 { color: #58a6ff; } .lvl-1 { color: #56d4dd; }
        .lvl-2 { color: #d29922; } .lvl-3 { color: #bc8cff; }
        .lvl-4 { color: #f85149; }

        .btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--input);
            color: var(--text);
            font: inherit;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .btn:hover { border-color: var(--accent); }
        .btn-go { background: var(--accent); border-color: var(--accent); color: var(--bg); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .actions { margin-top: 0.75rem; display: flex; gap: 0.5rem; }

        /* Status Bar */
        #status {
            background: var(--panel);
            border-top: 1px solid var(--border);
            padding: 0.5rem 1.5rem;
            display: flex;
            gap: 2rem;
            font-size: 0.75rem;
        }

        .st { display: flex; align-items: center; gap: 0.4rem; }
        .st-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--dim); }
        .st-dot.ok { background: var(--green); }
        .st-dot.warn { background: var(--yellow); }
        .st-dot.err { background: var(--red); }
        .st-label { color: var(--dim); }

        .level-bar { display: flex; gap: 2px; margin-left: auto; align-items: center; }
        .level-seg { width: 16px; height: 6px; background: var(--border); border-radius: 2px; }
        .level-seg.on { background: var(--accent); }
        .level-name { margin-left: 0.5rem; color: var(--dim); }

        #file-input { display: none; }

        .empty { color: var(--dim); text-align: center; padding: 2rem; grid-column: 1 / -1; }
    </style>
</head>
<body>
    <header>
        <div class="logo"><span>√ò</span>rthon</div>
        <div class="tagline">Diagnostic Framework</div>
    </header>

    <main>
        <div class="panel" id="config-panel">
            <div class="panel-title">
                Config
                <button class="btn" onclick="loadExample()">Example</button>
            </div>
            <textarea id="config" placeholder="# YAML config...
window_size: 50
window_stride: 25

signals:
  - name: sensor_1
  - name: sensor_2
"></textarea>
            <div class="actions">
                <button class="btn btn-go" onclick="check()">Check Capabilities</button>
            </div>
        </div>

        <div class="panel" id="data-panel">
            <div class="panel-title">Data</div>
            <div class="upload-zone" id="dropzone" onclick="$('file-input').click()">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Drop file or click<br><small>.parquet .csv .npz</small></div>
            </div>
            <input type="file" id="file-input" accept=".parquet,.csv,.npz" onchange="onFile(this)">
            <div id="file-info" class="file-info" style="display:none"></div>
            <div class="actions">
                <button class="btn btn-go" id="run-btn" disabled onclick="run()">Run Analysis</button>
            </div>
        </div>

        <div class="panel" id="cap-panel">
            <div class="panel-title">
                Capabilities
                <span id="cap-count">‚Äî</span>
            </div>
            <div class="cap-grid" id="caps">
                <div class="empty">Enter config and click "Check Capabilities"</div>
            </div>
        </div>
    </main>

    <div id="status">
        <div class="st">
            <div class="st-dot" id="cfg-dot"></div>
            <span class="st-label">Config:</span>
            <span id="cfg-st">‚Äî</span>
        </div>
        <div class="st">
            <div class="st-dot" id="data-dot"></div>
            <span class="st-label">Data:</span>
            <span id="data-st">‚Äî</span>
        </div>
        <div class="st">
            <div class="st-dot" id="eng-dot"></div>
            <span class="st-label">Engine:</span>
            <span id="eng-st">Idle</span>
        </div>
        <div class="level-bar">
            <span class="st-label">Level:</span>
            <div class="level-seg" id="l0"></div>
            <div class="level-seg" id="l1"></div>
            <div class="level-seg" id="l2"></div>
            <div class="level-seg" id="l3"></div>
            <div class="level-seg" id="l4"></div>
            <span class="level-name" id="lvl-name">‚Äî</span>
        </div>
    </div>

<script>
const $ = id => document.getElementById(id);

const CAPS = {
    STATISTICS:        { l: 0, n: 'Statistics', r: [] },
    DISTRIBUTION:      { l: 0, n: 'Distribution', r: [] },
    STATIONARITY:      { l: 0, n: 'Stationarity', r: [] },
    ENTROPY:           { l: 0, n: 'Entropy', r: [] },
    MEMORY:            { l: 0, n: 'Memory (Hurst)', r: [] },
    SPECTRAL:          { l: 0, n: 'Spectral', r: [] },
    RECURRENCE:        { l: 0, n: 'Recurrence', r: [] },
    CHAOS:             { l: 0, n: 'Chaos (Lyapunov)', r: [] },
    VOLATILITY:        { l: 0, n: 'Volatility', r: [] },
    EVENTS:            { l: 0, n: 'Event Detection', r: [] },
    GEOMETRY:          { l: 0, n: 'Geometry', r: [] },
    DYNAMICS:          { l: 0, n: 'Dynamics', r: [] },

    DERIVATIVES:       { l: 1, n: 'Derivatives', r: ['labeled'] },
    SPECIFIC_KE:       { l: 1, n: 'Specific KE', r: ['velocity'] },
    SPECIFIC_PE:       { l: 1, n: 'Specific PE', r: ['position'] },

    KINETIC_ENERGY:    { l: 2, n: 'Kinetic Energy', r: ['velocity', 'mass'] },
    POTENTIAL_ENERGY:  { l: 2, n: 'Potential Energy', r: ['position', 'spring_constant'] },
    MOMENTUM:          { l: 2, n: 'Momentum', r: ['velocity', 'mass'] },
    HAMILTONIAN:       { l: 2, n: 'Hamiltonian', r: ['position', 'velocity', 'mass', 'spring_constant'] },
    LAGRANGIAN:        { l: 2, n: 'Lagrangian', r: ['position', 'velocity', 'mass', 'spring_constant'] },

    WORK:              { l: 3, n: 'Work', r: ['position', 'force'] },
    GIBBS:             { l: 3, n: 'Gibbs Free Energy', r: ['temperature', 'pressure', 'volume', 'Cp'] },
    TRANSFER_FN:       { l: 3, n: 'Transfer Function', r: ['input', 'output'] },
    GRANGER:           { l: 3, n: 'Granger Causality', r: ['multi'] },
    TRANSFER_ENTROPY:  { l: 3, n: 'Transfer Entropy', r: ['multi'] },

    VORTICITY:         { l: 4, n: 'Vorticity', r: ['velocity_field'] },
    STRAIN:            { l: 4, n: 'Strain Tensor', r: ['velocity_field'] },
    Q_CRITERION:       { l: 4, n: 'Q-Criterion', r: ['velocity_field'] },
    TKE:               { l: 4, n: 'Turbulent KE', r: ['velocity_field'] },
    ENERGY_SPECTRUM:   { l: 4, n: 'E(k) Spectrum', r: ['velocity_field'] },
    REYNOLDS:          { l: 4, n: 'Reynolds Number', r: ['velocity_field', 'kinematic_viscosity'] },
};

const LEVELS = ['Raw Series', 'Labeled', 'Constants', 'Related', 'Spatial'];

let state = { cfg: null, file: null, level: 0 };

function parseYAML(txt) {
    const c = { signals: [], constants: {}, spatial: {} };
    let section = null, sig = null;
    
    for (let line of txt.split('\n')) {
        if (line.trim().startsWith('#') || !line.trim()) continue;
        
        const m = line.match(/^(\w+):\s*(.*)$/);
        if (m) {
            const [, k, v] = m;
            if (v) c[k] = isNaN(v) ? v : +v;
            else section = k;
        } else if (line.match(/^\s+-\s+name:\s*(.+)/)) {
            sig = { name: RegExp.$1 };
            c.signals.push(sig);
        } else if (sig && line.match(/^\s+physical_quantity:\s*(.+)/)) {
            sig.pq = RegExp.$1;
        } else if (section === 'constants' && line.match(/^\s+(\w+):\s*([\d.]+)/)) {
            c.constants[RegExp.$1] = +RegExp.$2;
        } else if (section === 'spatial' && line.match(/^\s+type:\s*(.+)/)) {
            c.spatial.type = RegExp.$1;
        } else if (section === 'relationships') {
            if (line.match(/temperature|pressure|volume/)) {
                c.thermo = true;
            }
            if (line.match(/input|output/)) {
                c.control = true;
            }
        }
    }
    return c;
}

function detect(cfg) {
    const has = new Set();
    
    if (cfg.signals.length >= 2) has.add('multi');
    for (const s of cfg.signals) {
        if (s.pq) {
            has.add('labeled');
            has.add(s.pq);
        }
    }
    for (const k in cfg.constants) has.add(k);
    if (cfg.thermo) ['temperature', 'pressure', 'volume'].forEach(x => has.add(x));
    if (cfg.control) { has.add('input'); has.add('output'); }
    if (cfg.spatial.type === 'velocity_field') has.add('velocity_field');

    const ok = [], no = {};
    for (const [k, cap] of Object.entries(CAPS)) {
        const miss = cap.r.filter(r => !has.has(r));
        if (miss.length === 0) ok.push(k);
        else no[k] = miss;
    }

    let lvl = 0;
    if (has.has('velocity_field')) lvl = 4;
    else if (has.has('temperature') || has.has('input')) lvl = 3;
    else if (has.has('mass') || has.has('spring_constant')) lvl = 2;
    else if (has.has('labeled')) lvl = 1;

    return { ok, no, lvl };
}

function renderCaps(res) {
    const el = $('caps');
    el.innerHTML = '';
    
    const all = Object.entries(CAPS).sort((a,b) => {
        const aOk = res.ok.includes(a[0]) ? 0 : 1;
        const bOk = res.ok.includes(b[0]) ? 0 : 1;
        return aOk - bOk || a[1].l - b[1].l;
    });

    for (const [k, cap] of all) {
        const isOk = res.ok.includes(k);
        const div = document.createElement('div');
        div.className = `cap ${isOk ? 'ok' : 'no'}`;
        div.innerHTML = `
            <span class="cap-icon">${isOk ? '‚úì' : '‚óã'}</span>
            <span class="cap-name">${cap.n}</span>
            <span class="lvl lvl-${cap.l}">L${cap.l}</span>
        `;
        if (!isOk) div.title = 'Need: ' + res.no[k].join(', ');
        el.appendChild(div);
    }
    
    $('cap-count').textContent = `${res.ok.length}/${Object.keys(CAPS).length}`;
}

function setLevel(lvl) {
    for (let i = 0; i <= 4; i++) {
        $('l' + i).className = 'level-seg' + (i <= lvl ? ' on' : '');
    }
    $('lvl-name').textContent = LEVELS[lvl];
}

function setSt(id, txt, state) {
    $(id + '-dot').className = 'st-dot' + (state ? ' ' + state : '');
    $(id + '-st').textContent = txt;
}

function check() {
    const txt = $('config').value;
    try {
        const cfg = parseYAML(txt);
        state.cfg = cfg;
        const res = detect(cfg);
        state.level = res.lvl;
        
        renderCaps(res);
        setLevel(res.lvl);
        setSt('cfg', `Valid (${cfg.signals.length} signals)`, 'ok');
        
        $('run-btn').disabled = !state.file;
    } catch (e) {
        setSt('cfg', 'Invalid', 'err');
    }
}

function onFile(input) {
    const f = input.files[0];
    if (!f) return;
    
    state.file = f;
    $('dropzone').classList.add('has-file');
    $('file-info').style.display = 'block';
    $('file-info').innerHTML = `<span class="name">${f.name}</span><span class="size">${(f.size/1024).toFixed(1)} KB</span>`;
    setSt('data', f.name, 'ok');
    $('run-btn').disabled = !state.cfg;
}

const dz = $('dropzone');
dz.ondragover = e => { e.preventDefault(); dz.classList.add('dragover'); };
dz.ondragleave = () => dz.classList.remove('dragover');
dz.ondrop = e => {
    e.preventDefault();
    dz.classList.remove('dragover');
    if (e.dataTransfer.files[0]) {
        $('file-input').files = e.dataTransfer.files;
        onFile($('file-input'));
    }
};

function loadExample() {
    $('config').value = `# Level 2: Mechanical with Constants
window_size: 100
window_stride: 50

signals:
  - name: position
    physical_quantity: position
  - name: velocity
    physical_quantity: velocity

constants:
  mass: 2.0
  spring_constant: 50.0
`;
    check();
}

function run() {
    setSt('eng', 'Running...', 'warn');
    setTimeout(() => {
        setSt('eng', 'Done', 'ok');
        alert('Analysis complete!\\n\\n(Shell demo - connect PRISM engine for real processing)');
    }, 1000);
}

setSt('cfg', '‚Äî', '');
setSt('data', '‚Äî', '');
setSt('eng', 'Idle', '');
</script>
</body>
</html>
